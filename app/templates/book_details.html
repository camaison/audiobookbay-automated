{% extends "base.html" %}

{% block title %}{{ book.title if book else 'Book Details' }} - AudiobookBay{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/book_details.css') }}">
{% endblock %}

{% block content %}
{% if error %}
    <div class="alert alert-error">
        <span class="alert-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="12" y1="9" x2="12" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="17" r="1" fill="currentColor"/></svg></span>
        {{ error }}
    </div>
    <div class="back-link">
        <a href="{{ url_for('home') }}" class="btn btn-secondary">‚Üê Back to Home</a>
    </div>
{% elif book %}
<div class="book-details">
    <div class="book-header">
        <div class="book-cover-large">
            <img src="{{ book.cover }}" alt="Cover for {{ book.title }}" 
                 onerror="this.src='/static/images/default_cover.jpg';">
        </div>
        
        <div class="book-main-info">
            <div class="book-breadcrumb">
                <a href="{{ url_for('home') }}">Home</a> / Book Details
            </div>
            
            <h1 class="book-title">{{ book.title }}</h1>
            
            {% if book.author %}
            <p class="book-author">by {{ book.author }}</p>
            {% endif %}
            
            {% if book.narrator %}
            <p class="book-narrator">Narrated by {{ book.narrator }}</p>
            {% endif %}
            
            <div class="book-actions">
                <button class="btn btn-primary btn-large" onclick="downloadBook('{{ book.original_url|escape }}', '{{ book.title|escape }}')">
                    üì• Download Audiobook
                </button>
                <button class="btn btn-outline favorite-btn" onclick="toggleFavorite('{{ book.original_url|escape }}', '{{ book.title|escape }}', '{{ book.author|escape }}', '{{ book.cover|escape }}', '{{ book.file_size|escape }}', '{{ book.bitrate|escape }}', '{{ book.language|escape }}', '{{ book.file_format|escape }}', '{{ book.duration|escape }}', '{{ book.category|escape }}', this)">
                    <span class="fav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span> <span class="fav-text">Favorite</span>
                </button>
                <a href="{{ book.original_url }}" target="_blank" class="btn btn-outline">
                    üîó View Original
                </a>
            </div>
        </div>
    </div>
    
    <div class="book-content">
        <!-- Main book information in clean layout -->
        <div class="book-info-section">
            {% if book.description %}
            <div class="description-section">
                <h3>About This Audiobook</h3>
                <div class="description-content">
                    {{ book.description }}
                </div>
            </div>
            {% endif %}
            
            <!-- Essential metadata in a compact, organized way -->
            <div class="metadata-grid">
                {% if book.narrator %}
                <div class="metadata-item">
                    <span class="metadata-label">Narrator</span>
                    <span class="metadata-value">{{ book.narrator }}</span>
                </div>
                {% endif %}
                
                {% if book.file_format %}
                <div class="metadata-item">
                    <span class="metadata-label">Format</span>
                    <span class="metadata-value">{{ book.file_format }}</span>
                </div>
                {% endif %}
                
                {% if book.bitrate %}
                <div class="metadata-item">
                    <span class="metadata-label">Quality</span>
                    <span class="metadata-value">{{ book.bitrate }}</span>
                </div>
                {% endif %}
                
                {% if book.file_size %}
                <div class="metadata-item">
                    <span class="metadata-label">Size</span>
                    <span class="metadata-value">{{ book.file_size }}</span>
                </div>
                {% endif %}
                
                <div class="metadata-item">
                    <span class="metadata-label">Language</span>
                    <span class="metadata-value">{{ book.language or 'English' }}</span>
                </div>
                
                {% if book.category %}
                <div class="metadata-item">
                    <span class="metadata-label">Genre</span>
                    <span class="metadata-value">{{ book.category }}</span>
                </div>
                {% endif %}
            </div>
            
        </div>
        
        
        {% if book.comments and book.comments|length > 0 %}
        <div class="book-comments">
            <h3>Comments & Reviews ({{ book.comments|length }})</h3>
            <div class="comments-list">
                {% for comment in book.comments %}
                <div class="comment-item">
                    <div class="comment-header">
                        <span class="comment-author">{{ comment.author }}</span>
                        {% if comment.rating %}
                        <span class="comment-rating">{{ comment.rating }}</span>
                        {% endif %}
                        {% if comment.date %}
                        <span class="comment-date">{{ comment.date }}</span>
                        {% endif %}
                    </div>
                    <div class="comment-content">
                        {{ comment.content or comment.text }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if related_books and related_books|length > 0 %}
        <div class="related-books">
            <h3>Related Books</h3>
            <div class="related-books-grid">
                {% for book in related_books %}
                <div class="related-book-item">
                    <a href="{{ url_for('book_details', book_url=book.link|urlencode) }}" class="related-book-link">
                        <img src="{{ book.cover }}" alt="Cover for {{ book.title }}" 
                             class="related-book-cover" onerror="this.src='/static/images/default_cover.jpg';">
                        <div class="related-book-info">
                            <h4 class="related-book-title">{{ book.title }}</h4>
                            {% if book.author %}
                            <p class="related-book-author">by {{ book.author }}</p>
                            {% endif %}
                            {% if book.category %}
                            <span class="related-book-category">{{ book.category }}</span>
                            {% endif %}
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
function downloadBook(link, title) {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="32" stroke-dashoffset="32"><animate attributeName="stroke-dasharray" dur="2s" values="0 32;16 16;0 32;0 32" repeatCount="indefinite"/><animate attributeName="stroke-dashoffset" dur="2s" values="0;-16;-32;-32" repeatCount="indefinite"/></circle></svg> Processing...';
    button.disabled = true;

    fetch('/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ link: link, title: title })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.message.includes('successfully') ? 'success' : 'error');
        if (data.message.includes('successfully')) {
            // Redirect to downloads page after successful download
            setTimeout(() => {
                window.location.href = '{{ url_for("status") }}';
            }, 2000);
        }
    })
    .catch(error => {
        showNotification('Failed to add download: ' + error.message, 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Favorites functionality
async function toggleFavorite(link, title, author, cover, fileSize, bitrate, language, fileFormat, duration, category, button) {
    const favIcon = button.querySelector('.fav-icon');
    const favText = button.querySelector('.fav-text');
    const originalIcon = favIcon.textContent;
    const originalText = favText.textContent;
    
    // Show loading state
    favIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="32" stroke-dashoffset="32"><animate attributeName="stroke-dasharray" dur="2s" values="0 32;16 16;0 32;0 32" repeatCount="indefinite"/><animate attributeName="stroke-dashoffset" dur="2s" values="0;-16;-32;-32" repeatCount="indefinite"/></circle></svg>';
    favText.textContent = 'Loading...';
    button.disabled = true;
    
    try {
        // Check if already favorite
        const checkResponse = await fetch('/api/favorites/check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ link: link })
        });
        const checkData = await checkResponse.json();
        
        if (checkData.is_favorite) {
            // Remove from favorites
            const response = await fetch('/api/favorites/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ link: link })
            });
            const data = await response.json();
            
            if (data.status === 'removed') {
                favIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                favText.textContent = 'Favorite';
                showNotification('Removed from favorites', 'success');
            } else {
                throw new Error('Failed to remove from favorites');
            }
        } else {
            // Add to favorites
            const response = await fetch('/api/favorites/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    link: link, 
                    title: title, 
                    author: author, 
                    cover: cover, 
                    file_size: fileSize,
                    bitrate: bitrate || '',
                    language: language || 'English',
                    file_format: fileFormat || '',
                    duration: duration || '',
                    category: category || ''
                })
            });
            const data = await response.json();
            
            if (data.status === 'added' || data.status === 'exists') {
                favIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z"/></svg>';
                favText.textContent = 'Favorited';
                showNotification(data.message, 'success');
            } else {
                throw new Error('Failed to add to favorites');
            }
        }
    } catch (error) {
        console.error('Error toggling favorite:', error);
        favIcon.textContent = originalIcon;
        favText.textContent = originalText;
        showNotification('Error updating favorites', 'error');
    } finally {
        button.disabled = false;
    }
}

function showNotification(message, type = 'info') {
    // Remove any existing notifications
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }

    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">${type === 'success' ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' : type === 'error' ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/><line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/></svg>' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6v6m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'}</span>
            <span class="notification-text">${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
        </div>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification && notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Check if this book is already favorited on page load
document.addEventListener('DOMContentLoaded', function() {
    const favoriteBtn = document.querySelector('.favorite-btn');
    if (favoriteBtn) {
        const bookLink = "{{ book.original_url|escape }}";
        checkAndUpdateFavoriteButton(bookLink, favoriteBtn);
    }
});

async function checkAndUpdateFavoriteButton(link, button) {
    try {
        const response = await fetch('/api/favorites/check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ link: link })
        });
        const data = await response.json();
        
        const favIcon = button.querySelector('.fav-icon');
        const favText = button.querySelector('.fav-text');
        
        if (data.is_favorite) {
            favIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z"/></svg>';
            favText.textContent = 'Favorited';
        }
    } catch (error) {
        console.error('Error checking favorite status:', error);
    }
}
</script>
{% endblock %}