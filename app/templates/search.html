{% extends "base.html" %}

{% block title %}Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
{% endblock %}

{% block content %}

<div class="page-header">
    <h1 class="page-title">Search Audiobooks</h1>
</div>

<div class="search-container" id="searchContainer">
    <div class="search-form-wrapper">
        <form method="post" class="search-form" id="searchForm" onsubmit="showLoadingSpinner()">
            <input type="text" name="query" placeholder="Search for audiobooks..." class="search-bar" value="{{ query or '' }}" required 
                   onfocus="showHotSearches()" onblur="hideHotSearches()">
            <button type="submit" class="search-button">
                <span class="button-text">Search</span>
                <div class="button-spinner" id="button-spinner" style="display: none;">
                    <div class="spinner"></div>
                </div>
            </button>
        </form>
        
        <!-- Advanced Search Toggle - Now to the right -->
        <div class="search-filters">
            <button type="button" class="filter-toggle" onclick="toggleAdvancedSearch()">
                <span id="advancedIcon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>
                <span>Advanced Search</span>
            </button>
        </div>
    </div>
    
    <!-- Hot Search Tiles -->
    <div class="hot-search-section" id="hotSearchSection" style="display: none;">
        <div class="hot-search-label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/>
            </svg>
            <span>What others are searching</span>
        </div>
        <div class="hot-search-tiles" id="hotSearchTiles">
            <div class="loading-tiles">Loading popular searches...</div>
        </div>
    </div>
    
    <!-- Advanced Search Panel -->
    <div class="advanced-search-panel" id="advancedSearchPanel" style="display: none;">
        <!-- Search Parameters -->
        <div class="search-parameters">
            <div class="search-param-group">
                <label for="searchTitle">Title:</label>
                <input type="text" id="searchTitle" placeholder="Book title...">
            </div>
            <div class="search-param-group">
                <label for="searchAuthor">Author:</label>
                <input type="text" id="searchAuthor" placeholder="Author name...">
            </div>
            <div class="search-param-group">
                <label for="searchNarrator">Narrator:</label>
                <input type="text" id="searchNarrator" placeholder="Narrator name...">
            </div>
        </div>

        <!-- Browse Sections -->
        <div class="browse-sections">
            <!-- Age Section -->
            <div class="browse-section">
                <h3 class="section-title">Age</h3>
                <div class="section-items" id="ageItems">
                    <div class="loading-items">Loading age categories...</div>
                </div>
            </div>

            <!-- Category Section -->
            <div class="browse-section">
                <h3 class="section-title">Category</h3>
                <div class="section-items" id="categoryItems">
                    <div class="loading-items">Loading categories...</div>
                </div>
            </div>

            <!-- Modifiers Section -->
            <div class="browse-section">
                <h3 class="section-title">Modifiers</h3>
                <div class="section-items" id="modifierItems">
                    <div class="loading-items">Loading modifiers...</div>
                </div>
            </div>

            <!-- Popular Languages Section -->
            <div class="browse-section">
                <h3 class="section-title">Popular Languages</h3>
                <div class="section-items" id="languageItems">
                    <div class="loading-items">Loading languages...</div>
                </div>
            </div>

        </div>

        <!-- Advanced Search Actions -->
        <div class="advanced-search-actions">
            <button type="button" class="btn btn-secondary" onclick="clearAdvancedSearch()">Clear All</button>
            <button type="button" class="btn btn-primary" onclick="performAdvancedSearch()">Search with Filters</button>
        </div>
    </div>
</div>

<div class="message-scroller" id="message-scroller">
    <p id="scrolling-message"></p>
</div>

<div class="loading-spinner" id="loading-spinner">
    <div class="spinner"></div>
    <p>Searching for audiobooks...</p>
</div>

{% if error %}
    <div class="error-message">{{ error }}</div>
{% endif %}

<!-- Search Results Container -->
<div class="books-grid" id="resultsGrid" style="display: none;">
    {% if books %}
    {% for book in books %}
    <article class="book-item">
        <div class="book-cover" onclick="goToDetails('{{ url_for('book_details', book_url=book.link|urlencode) }}')">
            <img src="{{ book.cover }}" alt="Cover for {{ book.title }}" 
                 onerror="this.src='/static/images/default_cover.jpg';">
        </div>
        <div class="book-info">
            <h3 class="book-title" onclick="goToDetails('{{ url_for('book_details', book_url=book.link|urlencode) }}')">{{ book.title }}</h3>
            {% if book.author %}
            <p class="book-author">by {{ book.author }}</p>
            {% endif %}
            
            <!-- Enhanced Metadata Display -->
            <div class="book-meta-detailed">
                {% if book.category %}<span class="meta-tag category">{{ book.category }}</span>{% endif %}
                {% if book.language %}<span class="meta-tag">{{ book.language }}</span>{% endif %}
                {% if book.file_format %}<span class="meta-tag">{{ book.file_format }}</span>{% endif %}
                {% if book.bitrate %}<span class="meta-tag">{{ book.bitrate }}</span>{% endif %}
                {% if book.file_size %}<span class="meta-tag size">{{ book.file_size }}</span>{% endif %}
                {% if book.duration %}<span class="meta-tag">{{ book.duration }}</span>{% endif %}
            </div>
            
            {% if book.keywords %}
            <div class="book-keywords">
                <span class="keywords-text">{{ book.keywords }}</span>
            </div>
            {% endif %}
            
            <div class="book-details-small">
                {% if book.upload_date %}<span class="upload-date">Uploaded: {{ book.upload_date }}</span>{% endif %}
                {% if book.explicit %}<span class="explicit-warning">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="12" y1="9" x2="12" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="17" r="1" fill="currentColor"/>
                    </svg>
                    Explicit
                </span>{% endif %}
                {% if book.abridged %}<span class="abridged-indicator">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 19.5A2.5 2.5 0 0 1 1.5 17V7A2.5 2.5 0 0 1 4 4.5h16A2.5 2.5 0 0 1 22.5 7v10a2.5 2.5 0 0 1-2.5 2.5H4z" stroke="currentColor" stroke-width="2"/>
                        <path d="M16 12l-4-2v4l4-2z" fill="currentColor"/>
                    </svg>
                    Abridged
                </span>{% endif %}
            </div>
            <div class="book-actions">
                <button class="book-btn favorite" onclick="addToFavorites('{{ book.link|escape }}', '{{ book.title|escape }}', '{{ book.author|escape }}', '{{ book.cover|escape }}', '{{ book.file_size|escape }}', '{{ book.bitrate|escape }}', '{{ book.language|escape }}', '{{ book.file_format|escape }}', '{{ book.duration|escape }}', '{{ book.category|escape }}', this)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Favorite
                </button>
                <button class="book-btn secondary" onclick="quickDownload('{{ book.link|escape }}', '{{ book.title|escape }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Download
                </button>
            </div>
        </div>
    </article>
    {% endfor %}
    {% endif %}
</div>

<!-- Infinite Scroll Loading -->
<div class="infinite-loading" id="infiniteLoading" style="display: none;">
    <div class="loading-content">
        <div class="loading-message" id="loadingMessage">Loading more audiobooks...</div>
        <div class="loading-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="loadingProgress"></div>
            </div>
        </div>
    </div>
</div>

<!-- End of Results Indicator -->
<div class="end-of-results" id="endOfResults" style="display: none;">
    <div class="end-message">
        <p>That's all folks! No more audiobooks to show.</p>
        <p class="end-subtitle">Try a different search term to find more books</p>
    </div>
</div>

<!-- Keep the old table hidden as fallback -->
<table style="display: none;">
    <tbody>
        {% for book in books %}
        <tr>
            <td><img src="{{ book.cover }}" alt="Cover Art" class="cover" width="100"></td>
            <td>{{ book.title }}</td>
            <td> 
                <button onclick="window.open('{{ book.link }}', '_blank')">Details</button>
                <button onclick="sendToQB('{{ book.link|escape }}', '{{ book.title|escape }}')">Download to Server</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    // Global search state
    let currentQuery = '';
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    let messageInterval;
    let progressInterval;
    let activeFilters = [];
    let filtersVisible = false;

    // Funny loading messages
    const messages = [
        "Searching for audiobooks...",
        "Hold on, this takes a while...",
        "Still searching... Maybe grab a snack?",
        "Patience, young grasshopper...",
        "Wow, this is taking a minute!",
        "Don't worry, I got this!",
        "Maybe go for a walk?",
        "Still thinking... Almost there!",
        "Finding the best results for you!",
        "Hang tight! Searching magic happening!",
        "One moment... while I consult the ancients.",
        "Beep boop... processing... please wait...",
        "My hamsters are running on a wheel, almost there!",
        "Just gathering some pixie dust, be right back!",
        "Is it lunchtime yet? Oh, searching... right.",
        "Please remain calm, the search is in progress.",
        "Warning: Search may cause extreme awesomeness.",
        "Calculating the optimal route to your results...",
        "Almost there... just defragmenting my brain.",
        "Searching... because the internet is a big place!",
        "Polishing the search results for your viewing pleasure.",
        "The search is strong with this one.",
        "Please wait while I summon the search demons.",
        "Searching in hyperspace... almost there!",
        "My coffee is kicking in... search commencing!",
        "Just a few more gigabytes to process...",
        "Rome wasn't built in a day.",
        "Don't blame me, the internet is slow today.",
        "Almost there... just need to find the right key...",
        "Diving deep into the audiobook ocean...",
        "Consulting the audiobook gods...",
        "Loading more literary goodness...",
        "Fetching fresh audiobook treasures...",
        "Calibrating the book-finding sensors...",
        "Asking the library spirits for guidance...",
        "Untangling the web of literary wisdom...",
        "Searching through the archives of awesomeness...",
        "The digital librarians are hard at work...",
        "Summoning books from the cloud dimension...",
        "Brewing the perfect search algorithm...",
        "Teaching my algorithms to speed read...",
        "Convincing the servers to work overtime...",
        "Searching with the intensity of a thousand bookworms...",
        "Organizing the chaos of the internet for you...",
        "My search spells are almost ready...",
        "Translating binary into book magic...",
        "The audiobook universe is vast, but we'll find it...",
        "Computing the probability of literary satisfaction...",
        "Searching through dimensions of storytelling...",
        "My neural networks are having book club discussions...",
        "Downloading wisdom from the cloud library...",
        "Teaching electrons to carry audiobook data faster...",
        "The search continues... greatness takes time!",
        "Polishing each result until it sparkles...",
        "My circuits are humming with anticipation...",
        "Scanning the literary multiverse...",
        "The audiobook matrix is being decoded...",
        "Searching with the passion of a book lover...",
        "Converting caffeine into search algorithms...",
        "The digital dust is settling on your results...",
        "My processors are working up a sweat...",
        "Channeling the spirits of great authors...",
        "The search robots are doing their happy dance...",
        "Consulting the ancient scrolls of the internet...",
        "My hard drives are spinning tales of discovery...",
        "The binary code is whispering secrets...",
        "Searching through the cosmic library catalog...",
        "My algorithms are having an eureka moment...",
        "The search journey continues through cyberspace...",
        "Teaching my servers the art of patience...",
        "The audiobook treasure hunt is in progress..."
    ];

    function showLoadingSpinner() {
        const buttonSpinner = document.getElementById('button-spinner');
        buttonSpinner.style.display = 'inline-block';
        setTimeout(showScrollingMessages, 2000);
    }

    function hideLoadingSpinner() {
        const buttonSpinner = document.getElementById('button-spinner');
        buttonSpinner.style.display = 'none';
        hideScrollingMessages();
    }

    function showScrollingMessages() {
        const messageScroller = document.getElementById('message-scroller');
        const scrollingMessage = document.getElementById('scrolling-message');
        
        if (!messageScroller || !scrollingMessage) return;
        
        messageScroller.style.display = 'block';
        let messageIndex = 0;
        const shuffledMessages = [...messages].sort(() => Math.random() - 0.5);
        
        scrollingMessage.textContent = shuffledMessages[messageIndex];
        
        messageInterval = setInterval(() => {
            messageIndex = (messageIndex + 1) % shuffledMessages.length;
            scrollingMessage.textContent = shuffledMessages[messageIndex];
        }, 3000);
    }

    function hideScrollingMessages() {
        const messageScroller = document.getElementById('message-scroller');
        if (messageScroller) {
            messageScroller.style.display = 'none';
        }
        if (messageInterval) {
            clearInterval(messageInterval);
        }
    }

    // Infinite scrolling functionality
    function showInfiniteLoading() {
        const loading = document.getElementById('infiniteLoading');
        const messageEl = document.getElementById('loadingMessage');
        const progressEl = document.getElementById('loadingProgress');
        
        if (!loading) return;
        
        loading.style.display = 'flex';
        
        // Cycle through funny messages
        let messageIndex = 0;
        const shuffledMessages = [...messages].sort(() => Math.random() - 0.5);
        messageEl.textContent = shuffledMessages[messageIndex];
        
        messageInterval = setInterval(() => {
            messageIndex = (messageIndex + 1) % shuffledMessages.length;
            messageEl.textContent = shuffledMessages[messageIndex];
        }, 2500);
        
        // Animate progress bar
        let progress = 0;
        progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressEl.style.width = progress + '%';
        }, 200);
    }

    function hideInfiniteLoading() {
        const loading = document.getElementById('infiniteLoading');
        if (loading) {
            loading.style.display = 'none';
        }
        if (messageInterval) {
            clearInterval(messageInterval);
        }
        if (progressInterval) {
            clearInterval(progressInterval);
        }
        
        const progressEl = document.getElementById('loadingProgress');
        if (progressEl) {
            progressEl.style.width = '0%';
        }
    }

    function showEndOfResults() {
        const endEl = document.getElementById('endOfResults');
        if (endEl) {
            endEl.style.display = 'flex';
        }
    }

    function hideEndOfResults() {
        const endEl = document.getElementById('endOfResults');
        if (endEl) {
            endEl.style.display = 'none';
        }
    }

    // Load more results
    async function loadMoreResults() {
        if (isLoading || !hasMore || !currentQuery) return;
        
        isLoading = true;
        showInfiniteLoading();
        
        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(currentQuery)}&page=${currentPage + 1}`);
            const data = await response.json();
            
            if (data.books && data.books.length > 0) {
                currentPage++;
                appendResults(data.books);
                hasMore = data.has_more;
            } else {
                hasMore = false;
            }
            
            if (!hasMore) {
                showEndOfResults();
            }
        } catch (error) {
            console.error('Failed to load more results:', error);
            showNotification('Failed to load more results', 'error');
        } finally {
            isLoading = false;
            hideInfiniteLoading();
        }
    }

    function appendResults(books) {
        const grid = document.getElementById('resultsGrid');
        if (!grid) return;
        
        books.forEach(book => {
            const bookCard = createBookCard(book);
            grid.appendChild(bookCard);
        });
    }

    function createBookCard(book) {
        const card = document.createElement('article');
        card.className = 'book-item';
        
        card.innerHTML = `
            <div class="book-cover" onclick="goToDetails('/book/${encodeURIComponent(book.link)}')">
                <img src="${book.cover}" alt="Cover for ${book.title}" 
                     onerror="this.src='/static/images/default_cover.jpg';">
            </div>
            <div class="book-info">
                <h3 class="book-title" onclick="goToDetails('/book/${encodeURIComponent(book.link)}')">${book.title}</h3>
                ${book.author ? `<p class="book-author">by ${book.author}</p>` : ''}
                <!-- Enhanced Metadata Display (SAME AS HOMEPAGE) -->
                <div class="book-meta-detailed">
                    ${book.category ? `<span class="meta-tag category">${book.category}</span>` : ''}
                    ${book.language ? `<span class="meta-tag">${book.language}</span>` : ''}
                    ${book.file_format ? `<span class="meta-tag">${book.file_format}</span>` : ''}
                    ${book.bitrate ? `<span class="meta-tag">${book.bitrate}</span>` : ''}
                    ${book.file_size ? `<span class="meta-tag size">${book.file_size}</span>` : ''}
                    ${book.duration ? `<span class="meta-tag">${book.duration}</span>` : ''}
                </div>
                <div class="book-actions">
                    <button class="book-btn favorite" onclick="addToFavorites('${book.link.replace(/'/g, "\\'")}', '${book.title.replace(/'/g, "\\'")}', '${(book.author || '').replace(/'/g, "\\'")}', '${book.cover.replace(/'/g, "\\'")}', '${(book.file_size || '').replace(/'/g, "\\'")}', '${(book.bitrate || '').replace(/'/g, "\\'")}', '${(book.language || 'English').replace(/'/g, "\\'")}', '${(book.file_format || '').replace(/'/g, "\\'")}', '${(book.duration || '').replace(/'/g, "\\'")}', '${(book.category || '').replace(/'/g, "\\'")}', this)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Favorite
                    </button>
                    <button class="book-btn secondary" onclick="quickDownload('${book.link.replace(/'/g, "\\'")}', '${book.title.replace(/'/g, "\\'")}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Download
                    </button>
                </div>
            </div>
        `;
        
        return card;
    }

    // Handle initial search form submission
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('.search-form');
        const grid = document.getElementById('resultsGrid');
        
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const query = form.querySelector('input[name="query"]').value.trim();
                if (!query) return;
                
                // Reset state
                currentQuery = query;
                currentPage = 1;
                hasMore = true;
                isLoading = true;
                
                // Clear previous results
                if (grid) {
                    grid.innerHTML = '';
                    grid.style.display = 'none';
                }
                hideEndOfResults();
                
                // Show loading
                showLoadingSpinner();
                
                // Perform search
                performInitialSearch(query);
            });
        }

        // Set up infinite scroll
        window.addEventListener('scroll', function() {
            if (isLoading || !hasMore) return;
            
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            
            // Trigger when user is 200px from bottom
            if (scrollTop + windowHeight >= documentHeight - 200) {
                loadMoreResults();
            }
        });

        // Show initial results if any
        {% if books %}
        const grid = document.getElementById('resultsGrid');
        if (grid) {
            grid.style.display = 'grid';
        }
        {% endif %}
    });

    async function performInitialSearch(query) {
        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&page=1`);
            const data = await response.json();
            
            const grid = document.getElementById('resultsGrid');
            const searchContainer = document.getElementById('searchContainer');
            
            if (data.books && data.books.length > 0) {
                // Clear and populate grid
                grid.innerHTML = '';
                data.books.forEach(book => {
                    const bookCard = createBookCard(book);
                    grid.appendChild(bookCard);
                });
                
                grid.style.display = 'grid';
                hasMore = data.has_more;
                
                // Move search container up
                searchContainer.classList.add('compact');
            } else {
                grid.innerHTML = '<div class="no-results"><div class="no-results-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 19.5A2.5 2.5 0 0 1 1.5 17V7A2.5 2.5 0 0 1 4 4.5h16A2.5 2.5 0 0 1 22.5 7v10a2.5 2.5 0 0 1-2.5 2.5H4z" stroke="currentColor" stroke-width="2"/></svg></div><p>No audiobooks found for your search.</p><p class="subtitle">Try different keywords or browse our featured books.</p></div>';
                grid.style.display = 'flex';
                hasMore = false;
                
                // Move search container up even for no results
                searchContainer.classList.add('compact');
            }
        } catch (error) {
            console.error('Search failed:', error);
            showNotification('Search failed. Please try again.', 'error');
        } finally {
            isLoading = false;
            document.getElementById('loading-spinner').style.display = 'none';
            hideScrollingMessages();
            hideLoadingSpinner();
        }
    }

    function sendToQB(link, title) {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<div class="spinner" style="width:16px;height:16px;margin:0 auto;"></div>';
        button.disabled = true;

        fetch('/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ link: link, title: title })
        })
        .then(response => response.json())
        .then(data => {
            showNotification(data.message, data.message.includes('successfully') ? 'success' : 'error');
        })
        .catch(error => {
            showNotification('Failed to add download: ' + error.message, 'error');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    function showNotification(message, type = 'info') {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        const iconSvg = type === 'success' 
            ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
            : type === 'error' 
            ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/><line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/></svg>'
            : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6v6m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-icon">${iconSvg}</span>
                <span class="notification-text">${message}</span>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
            </div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification && notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // Advanced Search Functions
    function toggleFilters() {
        const advancedSearch = document.getElementById('advancedSearch');
        const filterIcon = document.getElementById('filterIcon');
        
        filtersVisible = !filtersVisible;
        
        if (filtersVisible) {
            advancedSearch.style.display = 'block';
            filterIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        } else {
            advancedSearch.style.display = 'none';
            filterIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        }
    }

    function clearFilters() {
        activeFilters = [];
        const chips = document.querySelectorAll('.filter-chip');
        chips.forEach(chip => chip.classList.remove('active'));
    }

    function applyFilters() {
        const searchInput = document.querySelector('.search-bar');
        let searchTerm = searchInput.value.trim();
        
        // Combine original search with filters
        if (activeFilters.length > 0) {
            const filterTerms = activeFilters.join(' ');
            searchTerm = searchTerm ? `${searchTerm} ${filterTerms}` : filterTerms;
        }
        
        if (searchTerm) {
            // Update the search input to show the combined search
            currentQuery = searchTerm;
            currentPage = 1;
            hasMore = true;
            isLoading = true;
            
            // Clear previous results
            const grid = document.getElementById('resultsGrid');
            if (grid) {
                grid.innerHTML = '';
                grid.style.display = 'none';
            }
            hideEndOfResults();
            
            // Show loading
            showLoadingSpinner();
            
            // Perform search
            performInitialSearch(searchTerm);
        }
    }

    // Initialize filter chips
    document.addEventListener('DOMContentLoaded', function() {
        // Check for URL parameters and perform search if query exists
        const urlParams = new URLSearchParams(window.location.search);
        const queryParam = urlParams.get('q');
        
        if (queryParam) {
            const searchInput = document.querySelector('.search-bar');
            if (searchInput) {
                searchInput.value = queryParam;
                // Trigger search automatically
                currentQuery = queryParam;
                currentPage = 1;
                hasMore = true;
                isLoading = true;
                
                // Show loading properly
                document.getElementById('loading-spinner').style.display = 'flex';
                showScrollingMessages();
                performInitialSearch(queryParam);
            }
        }
        
        // Set up filter chip clicks
        const filterChips = document.querySelectorAll('.filter-chip');
        filterChips.forEach(chip => {
            chip.addEventListener('click', function() {
                const filter = this.dataset.filter;
                
                if (this.classList.contains('active')) {
                    // Remove filter
                    this.classList.remove('active');
                    activeFilters = activeFilters.filter(f => f !== filter);
                } else {
                    // Add filter
                    this.classList.add('active');
                    activeFilters.push(filter);
                }
            });
        });

        // Rest of existing DOMContentLoaded code...
        const form = document.querySelector('.search-form');
        const grid = document.getElementById('resultsGrid');
        
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const query = form.querySelector('input[name="query"]').value.trim();
                if (!query) return;
                
                // Reset state
                currentQuery = query;
                currentPage = 1;
                hasMore = true;
                isLoading = true;
                
                // Clear previous results
                if (grid) {
                    grid.innerHTML = '';
                    grid.style.display = 'none';
                }
                hideEndOfResults();
                
                // Show loading
                showLoadingSpinner();
                
                // Perform search
                performInitialSearch(query);
            });
        }

        // Set up infinite scroll
        window.addEventListener('scroll', function() {
            if (isLoading || !hasMore) return;
            
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            
            // Trigger when user is 200px from bottom
            if (scrollTop + windowHeight >= documentHeight - 200) {
                loadMoreResults();
            }
        });

        // Show initial results if any
        {% if books %}
        const grid = document.getElementById('resultsGrid');
        if (grid) {
            grid.style.display = 'grid';
        }
        {% endif %}
        
        // Load search history when advanced search is opened
        loadSearchHistory();
    });
    
    // Search history functionality
    async function loadSearchHistory() {
        try {
            const response = await fetch('/api/search/history');
            const data = await response.json();
            const historyContainer = document.getElementById('searchHistory');
            
            if (data.history && data.history.length > 0) {
                historyContainer.innerHTML = '';
                data.history.forEach(item => {
                    const chip = document.createElement('button');
                    chip.type = 'button';
                    chip.className = 'filter-chip history-chip';
                    chip.textContent = item.query;
                    chip.onclick = () => {
                        document.querySelector('input[name="query"]').value = item.query;
                        document.querySelector('.search-form').dispatchEvent(new Event('submit'));
                    };
                    historyContainer.appendChild(chip);
                });
            } else {
                historyContainer.innerHTML = '<div class="no-history">No recent searches</div>';
            }
        } catch (error) {
            console.error('Failed to load search history:', error);
            const historyContainer = document.getElementById('searchHistory');
            historyContainer.innerHTML = '<div class="no-history">Failed to load history</div>';
        }
    }
    
    // Navigate to book details when title or cover is clicked
    function goToDetails(url) {
        window.location.href = url;
    }
    
    // Favorites functionality
    async function toggleFavorite(link, title, author, cover, fileSize, button) {
        const favIcon = button.querySelector('.fav-icon');
        const favText = button.querySelector('.fav-text');
        const originalIcon = favIcon.textContent;
        const originalText = favText.textContent;
        
        // Show loading state
        favIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="32" stroke-dashoffset="32"><animate attributeName="stroke-dasharray" dur="2s" values="0 32;16 16;0 32;0 32" repeatCount="indefinite"/><animate attributeName="stroke-dashoffset" dur="2s" values="0;-16;-32;-32" repeatCount="indefinite"/></circle></svg>';
        favText.textContent = 'Loading...';
        button.disabled = true;
        
        try {
            // Check if already favorite
            const checkResponse = await fetch('/api/favorites/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ link: link })
            });
            const checkData = await checkResponse.json();
            
            if (checkData.is_favorite) {
                // Remove from favorites
                const response = await fetch('/api/favorites/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ link: link })
                });
                const data = await response.json();
                
                if (data.status === 'removed') {
                    favIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                    favText.textContent = 'Favorite';
                    showNotification('Removed from favorites', 'success');
                } else {
                    throw new Error('Failed to remove from favorites');
                }
            } else {
                // Add to favorites
                const response = await fetch('/api/favorites/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        link: link, 
                        title: title, 
                        author: author, 
                        cover: cover, 
                        file_size: fileSize 
                    })
                });
                const data = await response.json();
                
                if (data.status === 'added' || data.status === 'exists') {
                    favIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z"/></svg>';
                    favText.textContent = 'Favorited';
                    showNotification(data.message, 'success');
                } else {
                    throw new Error('Failed to add to favorites');
                }
            }
        } catch (error) {
            console.error('Error toggling favorite:', error);
            favIcon.textContent = originalIcon;
            favText.textContent = originalText;
            showNotification('Error updating favorites', 'error');
        } finally {
            button.disabled = false;
        }
    }
    
    // Update createBookCard to include favorite checking
    const originalCreateBookCard = createBookCard;
    createBookCard = function(book) {
        const card = originalCreateBookCard(book);
        
        // Check if this book is already favorited
        const favoriteBtn = card.querySelector('.favorite-btn');
        if (favoriteBtn) {
            checkAndUpdateFavoriteButton(book.link, favoriteBtn);
        }
        
        return card;
    };
    
    async function checkAndUpdateFavoriteButton(link, button) {
        try {
            const response = await fetch('/api/favorites/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ link: link })
            });
            const data = await response.json();
            
            const favIcon = button.querySelector('.fav-icon');
            const favText = button.querySelector('.fav-text');
            
            if (data.is_favorite) {
                favIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z"/></svg>';
                favText.textContent = 'Favorited';
            }
        } catch (error) {
            console.error('Error checking favorite status:', error);
        }
    }
    
    // Enhanced filter functionality for history chips
    function setupHistoryChips() {
        const historyChips = document.querySelectorAll('.history-chip');
        historyChips.forEach(chip => {
            chip.addEventListener('click', function() {
                const query = this.textContent;
                const searchInput = document.querySelector('input[name="query"]');
                searchInput.value = query;
                
                // Trigger search
                const form = document.querySelector('.search-form');
                form.dispatchEvent(new Event('submit'));
                
                // Close advanced search
                toggleFilters();
            });
        });
    }

    // Add to favorites function (copied from home.html)
    async function addToFavorites(link, title, author, cover, fileSize, bitrate, language, fileFormat, duration, category, button) {
        const originalHTML = button.innerHTML;
        button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="32" stroke-dashoffset="32"><animate attributeName="stroke-dasharray" dur="2s" values="0 32;16 16;0 32;0 32" repeatCount="indefinite"/><animate attributeName="stroke-dashoffset" dur="2s" values="0;-16;-32;-32" repeatCount="indefinite"/></circle></svg> Adding...';
        button.disabled = true;
        
        try {
            const response = await fetch('/api/favorites/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    link: link, 
                    title: title, 
                    author: author, 
                    cover: cover, 
                    file_size: fileSize,
                    bitrate: bitrate || '',
                    language: language || 'English',
                    file_format: fileFormat || '',
                    duration: duration || '',
                    category: category || ''
                })
            });
            const data = await response.json();
            
            if (data.status === 'added' || data.status === 'exists') {
                button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z"/></svg> Favorited';
                showNotification(data.message, 'success');
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }, 2000);
            } else {
                throw new Error('Failed to add to favorites');
            }
        } catch (error) {
            console.error('Error adding to favorites:', error);
            button.innerHTML = originalHTML;
            button.disabled = false;
            showNotification('Error adding to favorites', 'error');
        }
    }

    // Quick download function (copied from home.html)
    function quickDownload(link, title) {
        const button = event.target.closest('.book-btn');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="32" stroke-dashoffset="32"><animate attributeName="stroke-dasharray" dur="2s" values="0 32;16 16;0 32;0 32" repeatCount="indefinite"/><animate attributeName="stroke-dashoffset" dur="2s" values="0;-16;-32;-32" repeatCount="indefinite"/></circle></svg> Adding...';
        button.disabled = true;

        fetch('/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ link: link, title: title })
        })
        .then(response => response.json())
        .then(data => {
            showNotification(data.message, data.message.includes('successfully') ? 'success' : 'error');
            if (data.message.includes('successfully')) {
                button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Added';
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }, 2000);
            } else {
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        })
        .catch(error => {
            showNotification('Failed to add download: ' + error.message, 'error');
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }

    // Hot Search functionality
    let hotSearchData = [];
    
    async function loadHotSearches() {
        try {
            const response = await fetch('/api/browse/hot-search');
            const data = await response.json();
            
            if (data.searches && data.searches.length > 0) {
                hotSearchData = data.searches;
                displayHotSearchTiles();
            } else {
                // If no data, hide the section completely
                document.getElementById('hotSearchSection').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading hot searches:', error);
            // Hide section if there's an error
            document.getElementById('hotSearchSection').style.display = 'none';
        }
    }
    
    function displayHotSearchTiles() {
        const tilesContainer = document.getElementById('hotSearchTiles');
        tilesContainer.innerHTML = '';
        
        hotSearchData.forEach(search => {
            const tile = document.createElement('a');
            tile.className = 'hot-search-tile';
            tile.href = '#';
            tile.textContent = search.term;
            tile.onclick = (e) => {
                e.preventDefault();
                performHotSearch(search.term);
            };
            tilesContainer.appendChild(tile);
        });
    }
    
    function performHotSearch(term) {
        // Fill search bar and trigger search
        const searchInput = document.querySelector('.search-bar');
        searchInput.value = term;
        
        // Hide hot searches
        hideHotSearches();
        
        // Trigger search
        const form = document.querySelector('.search-form');
        form.dispatchEvent(new Event('submit'));
    }
    
    function showHotSearches() {
        const section = document.getElementById('hotSearchSection');
        if (hotSearchData.length > 0) {
            section.style.display = 'block';
        }
    }
    
    function hideHotSearches() {
        // Add small delay to allow tile clicks to work
        setTimeout(() => {
            document.getElementById('hotSearchSection').style.display = 'none';
        }, 200);
    }
    
    // Initialize browse sections on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Load hot searches first
        loadHotSearches();
        loadAllBrowseSections();
        
        // Handle URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const categoryParam = urlParams.get('category');
        
        if (categoryParam) {
            setTimeout(() => {
                selectBrowseItem('category', categoryParam);
            }, 1000); // Wait for sections to load
        }
    });

    // Load all browse sections dynamically
    async function loadAllBrowseSections() {
        await Promise.all([
            loadAgeSection(),
            loadCategorySection(),
            loadModifierSection(),
            loadLanguageSection()
        ]);
    }

    // Load Age section
    async function loadAgeSection() {
        try {
            const response = await fetch('/api/browse/ages');
            const data = await response.json();
            const container = document.getElementById('ageItems');
            
            if (data.ages && data.ages.length > 0) {
                container.innerHTML = '';
                data.ages.forEach(age => {
                    const item = createSectionItem(age.name, age.count, 'age', age.key);
                    container.appendChild(item);
                });
            } else {
                container.innerHTML = '<div class="section-item">No age categories available</div>';
            }
        } catch (error) {
            console.error('Error loading age section:', error);
            document.getElementById('ageItems').innerHTML = '<div class="section-item">Error loading ages</div>';
        }
    }

    // Load Category section
    async function loadCategorySection() {
        try {
            const response = await fetch('/api/browse/categories');
            const data = await response.json();
            const container = document.getElementById('categoryItems');
            
            if (data.categories && data.categories.length > 0) {
                container.innerHTML = '';
                data.categories.forEach(category => {
                    const item = createSectionItem(category.name, category.count, 'category', category.key);
                    container.appendChild(item);
                });
            } else {
                container.innerHTML = '<div class="section-item">No categories available</div>';
            }
        } catch (error) {
            console.error('Error loading category section:', error);
            document.getElementById('categoryItems').innerHTML = '<div class="section-item">Error loading categories</div>';
        }
    }

    // Load Modifiers section  
    async function loadModifierSection() {
        try {
            const response = await fetch('/api/browse/modifiers');
            const data = await response.json();
            const container = document.getElementById('modifierItems');
            
            if (data.modifiers && data.modifiers.length > 0) {
                container.innerHTML = '';
                data.modifiers.forEach(modifier => {
                    const item = createSectionItem(modifier.name, modifier.count, 'modifier', modifier.key);
                    container.appendChild(item);
                });
            } else {
                container.innerHTML = '<div class="section-item">No modifiers available</div>';
            }
        } catch (error) {
            console.error('Error loading modifier section:', error);
            document.getElementById('modifierItems').innerHTML = '<div class="section-item">Error loading modifiers</div>';
        }
    }

    // Load Languages section
    async function loadLanguageSection() {
        try {
            const response = await fetch('/api/browse/languages');
            const data = await response.json();
            const container = document.getElementById('languageItems');
            
            if (data.languages && data.languages.length > 0) {
                container.innerHTML = '';
                data.languages.forEach(language => {
                    const item = createSectionItem(language.name, language.count, 'language', language.key);
                    container.appendChild(item);
                });
            } else {
                container.innerHTML = '<div class="section-item">No languages available</div>';
            }
        } catch (error) {
            console.error('Error loading language section:', error);
            document.getElementById('languageItems').innerHTML = '<div class="section-item">Error loading languages</div>';
        }
    }


    // Create a section item element
    function createSectionItem(name, count, type, key) {
        const item = document.createElement('div');
        item.className = 'section-item';
        item.dataset.type = type;
        item.dataset.key = key;
        item.onclick = () => selectBrowseItem(type, key);
        
        const countSpan = count ? `<span class="item-count">${count}</span>` : '';
        item.innerHTML = `
            <span>${name}</span>
            ${countSpan}
        `;
        
        return item;
    }

    // Handle selecting browse items
    async function selectBrowseItem(type, key) {
        // Clear all active items
        document.querySelectorAll('.section-item.active').forEach(item => {
            item.classList.remove('active');
        });

        // Set clicked item as active
        const clickedItem = document.querySelector(`[data-type="${type}"][data-key="${key}"]`);
        if (clickedItem) {
            clickedItem.classList.add('active');
        }

        // Clear results and show loading
        const grid = document.getElementById('resultsGrid');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        grid.style.display = 'none';
        loadingSpinner.style.display = 'flex';

        try {
            const response = await fetch(`/api/browse/${type}/${encodeURIComponent(key)}?page=1`);
            const data = await response.json();
            
            if (data.books && data.books.length > 0) {
                // Clear and populate grid
                grid.innerHTML = '';
                data.books.forEach(book => {
                    const bookCard = createBookCard(book);
                    grid.appendChild(bookCard);
                });
                
                // Update search state
                currentQuery = `${type}:${key}`;
                currentPage = 1;
                hasMore = data.has_more || false;
                
                grid.style.display = 'grid';
            } else {
                grid.innerHTML = `<div class="no-results">No books found for ${name}</div>`;
                grid.style.display = 'block';
            }
        } catch (error) {
            console.error(`Error loading ${type} ${key}:`, error);
            grid.innerHTML = `<div class="error-message">Error loading books for ${name}</div>`;
            grid.style.display = 'block';
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    // Advanced Search Functions
    function toggleAdvancedSearch() {
        const panel = document.getElementById('advancedSearchPanel');
        const icon = document.getElementById('advancedIcon');
        
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            icon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            // Load browse sections when panel is opened
            if (!panel.dataset.loaded) {
                loadAllBrowseSections();
                panel.dataset.loaded = 'true';
            }
        } else {
            panel.style.display = 'none';
            icon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        }
    }

    function clearAdvancedSearch() {
        // Clear input fields
        document.getElementById('searchTitle').value = '';
        document.getElementById('searchAuthor').value = '';
        document.getElementById('searchNarrator').value = '';
        
        // Clear active filter selections
        document.querySelectorAll('.section-item.active').forEach(item => {
            item.classList.remove('active');
        });
    }

    async function performAdvancedSearch() {
        const title = document.getElementById('searchTitle').value.trim();
        const author = document.getElementById('searchAuthor').value.trim();
        const narrator = document.getElementById('searchNarrator').value.trim();
        
        // Get selected filters
        const activeFilters = [];
        document.querySelectorAll('.section-item.active').forEach(item => {
            activeFilters.push({
                type: item.dataset.type,
                key: item.dataset.key,
                name: item.textContent.trim()
            });
        });
        
        // Build search query
        let searchTerms = [];
        if (title) searchTerms.push(`title:${title}`);
        if (author) searchTerms.push(`author:${author}`);
        if (narrator) searchTerms.push(`narrator:${narrator}`);
        
        // Add filter terms
        activeFilters.forEach(filter => {
            if (filter.type === 'search') {
                searchTerms.push(filter.key);
            } else {
                searchTerms.push(`${filter.type}:${filter.key}`);
            }
        });
        
        if (searchTerms.length === 0) {
            alert('Please enter search terms or select filters');
            return;
        }
        
        const searchQuery = searchTerms.join(' ');
        console.log('Advanced search query:', searchQuery);
        
        // Perform the search
        currentQuery = searchQuery;
        currentPage = 1;
        hasMore = true;
        
        const grid = document.getElementById('resultsGrid');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        grid.style.display = 'none';
        loadingSpinner.style.display = 'flex';
        
        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(searchQuery)}&page=1`);
            const data = await response.json();
            
            if (data.books && data.books.length > 0) {
                grid.innerHTML = '';
                data.books.forEach(book => {
                    const bookCard = createBookCard(book);
                    grid.appendChild(bookCard);
                });
                
                hasMore = data.has_more || false;
                grid.style.display = 'grid';
                
                // Update main search bar
                document.querySelector('.search-bar').value = searchQuery;
            } else {
                grid.innerHTML = '<div class="no-results">No books found for your advanced search</div>';
                grid.style.display = 'block';
            }
        } catch (error) {
            console.error('Advanced search failed:', error);
            grid.innerHTML = '<div class="error-message">Advanced search failed. Please try again.</div>';
            grid.style.display = 'block';
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }
</script>

{% endblock %}
