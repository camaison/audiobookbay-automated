{% extends "base.html" %}

{% block title %}Torrent Status{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/status.css') }}">
{% endblock %}

{% block content %}
<div class="status-container">
    <div class="page-header">
        <h1 class="page-title">Download Status</h1>
        <p class="page-subtitle">Monitor your active downloads and completed audiobooks</p>
    </div>

    <div class="refresh-container">
        <button class="btn btn-secondary" onclick="location.reload()">
            Refresh Status
        </button>
        <div class="auto-stop-toggle">
            <label class="toggle-switch">
                <input type="checkbox" id="autoStopToggle" onchange="toggleAutoStop()">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Auto-stop when complete</span>
        </div>
    </div>

    {% if torrents %}
    <div class="status-table-container">
        <table class="status-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Progress</th>
                    <th>Status</th>
                    <th>Size</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for torrent in torrents %}
                <tr>
                    <td data-label="Title">
                        <span class="torrent-name" title="{{ torrent.name }}">{{ torrent.name }}</span>
                    </td>
                    <td data-label="Progress">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ torrent.progress }}%"></div>
                            </div>
                            <div class="progress-text">{{ torrent.progress }}%</div>
                        </div>
                    </td>
                    <td data-label="Status">
                        <span class="status-badge {% if torrent.state|lower == 'downloading' %}status-downloading{% elif torrent.state|lower == 'seeding' %}status-seeding{% elif torrent.state|lower == 'paused' %}status-paused{% elif torrent.state|lower == 'completed' %}status-completed{% else %}status-error{% endif %}">
                            {{ torrent.state }}
                        </span>
                    </td>
                    <td data-label="Size">
                        <span class="file-size">{{ torrent.size }}</span>
                    </td>
                    <td data-label="Actions">
                        <div class="torrent-actions">
                            {% if torrent.state|lower in ['downloading', 'seeding'] %}
                            <button class="btn btn-small btn-warning" onclick="pauseTorrent('{{ torrent.hash }}', this)" title="Pause">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="4" width="4" height="16" rx="1" fill="currentColor"/><rect x="14" y="4" width="4" height="16" rx="1" fill="currentColor"/></svg>
                            </button>
                            {% elif torrent.state|lower == 'paused' %}
                            <button class="btn btn-small btn-success" onclick="resumeTorrent('{{ torrent.hash }}', this)" title="Resume">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>
                            </button>
                            {% endif %}
                            <button class="btn btn-small btn-secondary" onclick="showTorrentInfo('{{ torrent.hash }}')" title="Info">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6v6m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="confirmDeleteTorrent('{{ torrent.hash }}', '{{ torrent.name|escape }}')" title="Delete">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üì•</div>
        <h3>No Active Downloads</h3>
        <p>Start downloading audiobooks from the search page to see them here.</p>
    </div>
    {% endif %}
</div>

<!-- Torrent Info Modal -->
<div class="modal" id="torrentInfoModal" style="display: none;">
    <div class="modal-overlay" onclick="closeTorrentInfoModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Torrent Details</h3>
            <button class="modal-close" onclick="closeTorrentInfoModal()">√ó</button>
        </div>
        <div class="modal-body" id="torrentInfoContent">
            <div class="loading-content">
                <div class="spinner"></div>
                <p>Loading torrent information...</p>
            </div>
        </div>
    </div>
</div>

<!-- Auto-refresh indicator -->
<div class="auto-refresh-indicator" id="autoRefreshIndicator">
    <div class="refresh-spinner"></div>
    <span>Auto-refreshing...</span>
</div>

<script>
    let updateInterval;
    let isUpdating = false;

    // Initialize real-time updates
    document.addEventListener('DOMContentLoaded', function() {
        startRealTimeUpdates();
        loadAutoStopSettings();
    });

    function startRealTimeUpdates() {
        // Update every 5 seconds
        updateInterval = setInterval(updateTorrentStatus, 5000);
    }

    function stopRealTimeUpdates() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    }

    async function updateTorrentStatus() {
        if (isUpdating) return;
        
        isUpdating = true;
        const indicator = document.getElementById('autoRefreshIndicator');
        
        try {
            indicator.classList.add('active');
            
            const response = await fetch('/api/torrent/status');
            const data = await response.json();
            
            if (response.ok && data.torrents) {
                updateTorrentTable(data.torrents);
            }
        } catch (error) {
            console.warn('Failed to update torrent status:', error);
        } finally {
            isUpdating = false;
            setTimeout(() => {
                indicator.classList.remove('active');
            }, 800);
        }
    }

    function updateTorrentTable(torrents) {
        const tbody = document.querySelector('.status-table tbody');
        if (!tbody || torrents.length === 0) {
            // If no torrents, show empty state or reload page
            if (torrents.length === 0 && tbody) {
                location.reload();
            }
            return;
        }

        // Update existing rows
        torrents.forEach(torrent => {
            const existingRow = findTorrentRow(torrent.hash);
            if (existingRow) {
                updateTorrentRow(existingRow, torrent);
            } else {
                // New torrent appeared, reload page
                location.reload();
                return;
            }
        });

        // Check for removed torrents
        const currentHashes = new Set(torrents.map(t => t.hash));
        const existingRows = tbody.querySelectorAll('tr');
        let removedCount = 0;

        existingRows.forEach(row => {
            const hash = extractHashFromRow(row);
            if (hash && !currentHashes.has(hash)) {
                removedCount++;
            }
        });

        // If torrents were removed, reload page
        if (removedCount > 0) {
            location.reload();
        }
    }

    function findTorrentRow(hash) {
        const rows = document.querySelectorAll('.status-table tbody tr');
        for (const row of rows) {
            if (extractHashFromRow(row) === hash) {
                return row;
            }
        }
        return null;
    }

    function extractHashFromRow(row) {
        // Extract hash from button onclick attributes
        const pauseBtn = row.querySelector('button[onclick*="pauseTorrent"]');
        const resumeBtn = row.querySelector('button[onclick*="resumeTorrent"]');
        const deleteBtn = row.querySelector('button[onclick*="confirmDeleteTorrent"]');
        
        const button = pauseBtn || resumeBtn || deleteBtn;
        if (button) {
            const onclick = button.getAttribute('onclick');
            const match = onclick.match(/'([^']+)'/);
            return match ? match[1] : null;
        }
        return null;
    }

    function updateTorrentRow(row, torrent) {
        // Update progress bar and percentage
        const progressFill = row.querySelector('.progress-fill');
        const progressText = row.querySelector('.progress-text');
        if (progressFill && progressText) {
            progressFill.style.width = `${torrent.progress}%`;
            progressText.textContent = `${torrent.progress}%`;
        }

        // Update status badge
        const statusBadge = row.querySelector('.status-badge');
        if (statusBadge) {
            statusBadge.textContent = torrent.state;
            statusBadge.className = `status-badge ${getStatusClass(torrent.state)}`;
        }

        // Update file size (in case it changes)
        const fileSize = row.querySelector('.file-size');
        if (fileSize) {
            fileSize.textContent = torrent.size;
        }

        // Update action buttons based on state
        updateActionButtons(row, torrent);
    }

    function updateActionButtons(row, torrent) {
        const actionsCell = row.querySelector('.torrent-actions');
        if (!actionsCell) return;

        const hash = torrent.hash;
        const state = torrent.state.toLowerCase();
        const escapedName = torrent.name.replace(/'/g, '\\\'');

        let buttonsHtml = '';

        // Pause/Resume button
        if (state === 'downloading' || state === 'seeding') {
            buttonsHtml += `
                <button class="btn btn-small btn-warning" onclick="pauseTorrent('${hash}', this)" title="Pause">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="6" y="4" width="4" height="16" rx="1" fill="currentColor"/>
                        <rect x="14" y="4" width="4" height="16" rx="1" fill="currentColor"/>
                    </svg>
                </button>
            `;
        } else if (state === 'paused') {
            buttonsHtml += `
                <button class="btn btn-small btn-success" onclick="resumeTorrent('${hash}', this)" title="Resume">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 5v14l11-7z" fill="currentColor"/>
                    </svg>
                </button>
            `;
        }

        // Info button (always present)
        buttonsHtml += `
            <button class="btn btn-small btn-secondary" onclick="showTorrentInfo('${hash}')" title="Info">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 6v6m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        `;

        // Delete button (always present)
        buttonsHtml += `
            <button class="btn btn-small btn-danger" onclick="confirmDeleteTorrent('${hash}', '${escapedName}')" title="Delete">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        `;

        actionsCell.innerHTML = buttonsHtml;
    }

    // Status badge color mapping
    function getStatusClass(state) {
        const stateMap = {
            'downloading': 'status-downloading',
            'seeding': 'status-seeding',
            'paused': 'status-paused',
            'completed': 'status-completed',
            'error': 'status-error'
        };
        return stateMap[state.toLowerCase()] || 'status-error';
    }

    // Torrent control functions
    async function pauseTorrent(hash, button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="32" stroke-dashoffset="32"><animate attributeName="stroke-dasharray" dur="2s" values="0 32;16 16;0 32;0 32" repeatCount="indefinite"/><animate attributeName="stroke-dashoffset" dur="2s" values="0;-16;-32;-32" repeatCount="indefinite"/></circle></svg>';
        button.disabled = true;
        
        try {
            const response = await fetch('/api/torrent/pause', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hash: hash })
            });
            const data = await response.json();
            
            if (response.ok) {
                showNotification('Torrent paused successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error || 'Failed to pause torrent', 'error');
            }
        } catch (error) {
            showNotification('Error pausing torrent: ' + error.message, 'error');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    async function resumeTorrent(hash, button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="32" stroke-dashoffset="32"><animate attributeName="stroke-dasharray" dur="2s" values="0 32;16 16;0 32;0 32" repeatCount="indefinite"/><animate attributeName="stroke-dashoffset" dur="2s" values="0;-16;-32;-32" repeatCount="indefinite"/></circle></svg>';
        button.disabled = true;
        
        try {
            const response = await fetch('/api/torrent/resume', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hash: hash })
            });
            const data = await response.json();
            
            if (response.ok) {
                showNotification('Torrent resumed successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error || 'Failed to resume torrent', 'error');
            }
        } catch (error) {
            showNotification('Error resuming torrent: ' + error.message, 'error');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    function confirmDeleteTorrent(hash, name) {
        if (confirm(`Are you sure you want to delete "${name}"?\n\nThis will remove the torrent from the download client but keep the files.`)) {
            deleteTorrent(hash, false);
        }
    }

    async function deleteTorrent(hash, deleteFiles = false) {
        try {
            const response = await fetch('/api/torrent/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hash: hash, delete_files: deleteFiles })
            });
            const data = await response.json();
            
            if (response.ok) {
                showNotification('Torrent deleted successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error || 'Failed to delete torrent', 'error');
            }
        } catch (error) {
            showNotification('Error deleting torrent: ' + error.message, 'error');
        }
    }

    async function showTorrentInfo(hash) {
        // Show modal with loading state
        const modal = document.getElementById('torrentInfoModal');
        const content = document.getElementById('torrentInfoContent');
        
        content.innerHTML = `
            <div class="loading-content">
                <div class="spinner"></div>
                <p>Loading torrent information...</p>
            </div>
        `;
        modal.style.display = 'flex';
        
        try {
            const response = await fetch('/api/torrent/info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hash: hash })
            });
            const data = await response.json();
            
            if (response.ok) {
                const info = data;
                const sizeFormatted = formatBytes(info.size);
                const downloadedFormatted = formatBytes(info.downloaded);
                const uploadSpeedFormatted = formatBytes(info.upload_speed) + '/s';
                const downloadSpeedFormatted = formatBytes(info.download_speed) + '/s';
                
                content.innerHTML = `
                    <div class="torrent-info-grid">
                        <div class="info-section">
                            <h4>General Information</h4>
                            <div class="info-item">
                                <span class="info-label">Name:</span>
                                <span class="info-value" title="${info.name}">${info.name}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Progress:</span>
                                <span class="info-value">
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${info.progress}%"></div>
                                        </div>
                                        <span class="progress-text">${info.progress}%</span>
                                    </div>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">State:</span>
                                <span class="info-value">
                                    <span class="status-badge status-${info.state.toLowerCase()}">${info.state}</span>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Hash:</span>
                                <span class="info-value hash-value" title="${hash}">${hash.substring(0, 16)}...</span>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h4>Size & Transfer</h4>
                            <div class="info-item">
                                <span class="info-label">Total Size:</span>
                                <span class="info-value">${sizeFormatted}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Downloaded:</span>
                                <span class="info-value">${downloadedFormatted}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Download Speed:</span>
                                <span class="info-value">${downloadSpeedFormatted}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Upload Speed:</span>
                                <span class="info-value">${uploadSpeedFormatted}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Ratio:</span>
                                <span class="info-value">${info.ratio || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ETA:</span>
                                <span class="info-value">${info.eta || 'Unknown'}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="error-content">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <p>Failed to load torrent information</p>
                        <small>${data.error || 'Unknown error occurred'}</small>
                    </div>
                `;
            }
        } catch (error) {
            content.innerHTML = `
                <div class="error-content">
                    <div class="error-icon">üîå</div>
                    <p>Connection Error</p>
                    <small>Unable to fetch torrent information: ${error.message}</small>
                </div>
            `;
        }
    }
    
    function closeTorrentInfoModal() {
        document.getElementById('torrentInfoModal').style.display = 'none';
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showNotification(message, type = 'info') {
        // Remove any existing notifications
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-icon">${type === 'success' ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' : type === 'error' ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/><line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/></svg>' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6v6m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'}</span>
                <span class="notification-text">${message}</span>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
            </div>
        `;

        // Add to page
        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification && notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // Auto-stop seeding toggle functions
    async function loadAutoStopSettings() {
        try {
            const response = await fetch('/api/settings/auto-stop');
            const data = await response.json();
            
            if (response.ok) {
                document.getElementById('autoStopToggle').checked = data.enabled;
            }
        } catch (error) {
            console.warn('Failed to load auto-stop settings:', error);
        }
    }

    async function toggleAutoStop() {
        const toggle = document.getElementById('autoStopToggle');
        const enabled = toggle.checked;
        
        try {
            const response = await fetch('/api/settings/auto-stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            });
            const data = await response.json();
            
            if (response.ok) {
                showNotification(data.message, 'success');
            } else {
                showNotification(data.error || 'Failed to update auto-stop setting', 'error');
                // Revert toggle state on error
                toggle.checked = !enabled;
            }
        } catch (error) {
            showNotification('Error updating auto-stop setting: ' + error.message, 'error');
            // Revert toggle state on error
            toggle.checked = !enabled;
        }
    }
</script>
{% endblock %}
